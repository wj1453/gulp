"use strict";var app=angular.module("tradeApp",["pascalprecht.translate","ngMessages","ngCookies"]).config(["$translateProvider","$httpProvider",function(e,t){e.translations("en",{BUY:"买入",SELL:"卖出",CANCELED:"已撤销",PARTIALLY_FILLED:"部分成交",NEW:"未成交",FILLED:"全部成交",REJECTED:"已拒绝",EXPIRED:"已过期"}),t.interceptors.push("myInterceptor"),e.preferredLanguage("en")}]).controller("tradeController",["$scope","$rootScope","$http","$interval","$cookies","$timeout","$document","$window","$q","streamer","user","$translate","userStreamer","exchangeDate","getRequest","myDate","klineStreamer",function(e,t,r,a,o,n,s,i,l,c,u,d,m,p,g,f,h){function y(t){if(t.length){e.products=t,localStorage.product=e.products[0].symbol;for(var r=t,a=0;a<r.length;a++)if(r[a].symbol==e.product.symbol){var o=r[a-1<0?a-1+r.length:a-1].symbol,n=r[(a+1)%r.length].symbol;e.pre=function(){window.location.replace("/exchange/"+PREFIX+"tradeDetail.html?symbol="+o)},e.next=function(){window.location.replace("/exchange/"+PREFIX+"tradeDetail.html?symbol="+n)},$(window).keyup(function(e){33==e.keyCode&&window.location.replace("/exchange/"+PREFIX+"tradeDetail.html?symbol="+o),34==e.keyCode&&window.location.replace("/exchange/"+PREFIX+"tradeDetail.html?symbol="+n)})}}else e.products=[];e.Islogin&&e.getUserInfo(t)}function b(t){if(t&&t instanceof Array){var r={};r.exch="BIJIE",r.orders=[],t.forEach(function(t){t.symbol==e.product.symbol&&r.orders.push({id:t.id,action:t.side.toLowerCase(),amount:t.origQty,price:t.price,base:t.symbol,quote:"CNY",status:"Open"})}),UserAccount.ordersAdd(r)}}var v=g,k=location.host.match("localhost")||location.host.match("192.168.0")?"/exchange/public":"/api/v1";e.product={},e.product.symbol=v.symbol||localStorage.product,e.curIndex=localStorage.curIndex||0,e.buy_order={},e.sell_order={},e.market_buy_order={},e.market_sell_order={},e.userMoney={},e.userAsset={};var I=f.today.getTime(),w=f.tomorrow.getTime(),S=[60,60,300,900,1800,3600,86400,604800],T=new Date(f.timePointFourth);e.stopDepthStream=!1;var _=(new Date).getTime();r.get("/exchange/public/serverTime").success(function(t){var r=(new Date).getTime(),o=(new Date).getTime()-t+(r-_)/2;e.today=new Date((new Date).getTime()-o),a(function(){e.today=new Date((new Date).getTime()-o+1e3)},1e3);var s=T.getTime()-e.today.getTime();s>0&&n(function(){e.stopDepthStream=!0},s);var i=new Date;i.setHours(9,1,0,0);var l=i.getTime()-e.today.getTime();l>0&&n(function(){e.refresh()},l)}),e.showLoginBox=u.login,e.logout=u.logout,e.showInfo=function(){angular.element(".wrap").addClass("blur"),angular.element(".overlayer,#guide-box").show()},e.hideInfo=function(){angular.element(".wrap").removeClass("blur"),angular.element(".overlayer,#guide-box").hide()},e.getUserMoney=function(){r.post("private/userMoney").success(function(t){e.userMoney=t,e.freeze=Number(t.freeze),e.withdrawFreeze=Number(t.withdrawFreeze),e.withdrawing=Number(t.withdrawing),e.withdrawable=Math.min(t.withdrawable,t.free),e.locked=Number(t.locked),e.free=Number(t.free)})},e.getUserBaseDetail=function(){r.post("/user/basedetail.html").success(function(t){e.userBaseInfo=t})},e.currentUserAsset=null,e.getUserAsset=function(t){r.post("/exchange/private/userAsset").success(function(r){e.userAssets=r,e.userAssetsNum=r.length,e.totalMarketValue=0,e.totalProfit=0,e.cost=0,e.totalAsset=0,e.freezeAsset=0,angular.forEach(r,function(r,a){r.price&&(e.totalMarketValue+=Number(r.price)*(Number(r.free)+Number(r.freeze)+Number(r.locked)+Number(r.withdrawing))),e.cost+=Number(r.cost),e.totalAsset+=Number(r.free),e.freezeAsset+=Number(r.freeze),r.productSymbol==t&&(e.currentUserAsset=r.free,e.currentMarketValue=Number(r.price)*(Number(r.free)+Number(r.freeze)+Number(r.locked)))}),e.totalProfit=e.totalMarketValue-e.cost})},e.refresh=function(){window.location.href=window.location.href},e.getOrders=function(){r.post("private/openOrders").success(function(t){b(t),e.openOrders=t,e.openOrdersLen=t.length,0==e.openOrdersLen?e.IsopenOrdersNull=!0:e.IsopenOrdersNull=!1})},e.getAllOrders=function(t,a,o,n){var s=$.param({page:t,start:o,rows:a,end:n});r.post("private/allOrders",s).success(function(t){t.data?e.allOrders=t.data:e.allOrders=[],0==t.total?e.IsallOrdersNull=!0:e.IsallOrdersNull=!1})},e.setTimequantum=function(e,t){var r=new Date,a=r.getFullYear(),o=r.getMonth(),n=r.getDate(),s=new Date(a,o,n,0,0,0),i=s.getTime(),l=new Date(a,o,n,0,0,0).setDate(new Date(a,o,n,0,0,0).getDate()+1);switch(e){case 0:i=s.getTime();break;case 1:i=Math.abs(s.setDate(s.getDate()-7));break;case 2:i=Math.abs(s.setMonth(s.getMonth()-1));break;case 3:i=Math.abs(s.setMonth(s.getMonth()-3))}t(1,1e3,i,l)},e.search_submit=function(e){var t=new Date($("#start").val()).getTime(),r=new Date($("#end").val());r=r.setDate(r.getDate()+1),t&&r&&e(1,1e3,t,r)},e.dealOrders=[],e.getDealOrders=function(t,a,o,n){var s=$.param({page:t,start:o,rows:a,end:n});r.post("/exchange/private/userTrades",s).success(function(t){t.data?e.dealOrders=t.data:e.dealOrders=[],e.dealBigTotalItems=t.total})},e.isLogin=function(){"y"==o.logined?(e.Islogin=!0,e.getUserMoney(),e.getUserBaseDetail(),e.getOrders(),e.getUserAsset(e.product.symbol),e.getAllOrders(1,1e3,I,w),e.getDealOrders(1,1e3,I,w)):e.Islogin=!1},e.isLogin(),e.getCurrentProduct=function(a){r.get("public/product?symbol="+a).success(function(r){if(r.data.length>0){e.currentProduct=r.data[0],chart.setData({circulation:e.currentProduct.circulation}),e.newest=e.currentProduct.close,t.pageTitle=e.currentProduct.name,angular.element("#trade-desc-con").html(e.currentProduct.desc),e.searchKeyword=e.currentProduct.name+" "+e.currentProduct.symbol;var a=f.currentTime,o=f.timePointFourth;if(a>=o){var n=240,s=e.currentProduct.avgQty/240,i=e.currentProduct.volume/n;0==s?e.volumeRatio="":e.volumeRatio=i/s}}})},e.getCurrentProduct(e.product.symbol),e.products=[],e.getTradeLists=function(){r.get("public/product").success(function(e){var t=new Date;t.setHours(8,0,0,0),t.getTime()<(new Date).getTime()&&t.setDate(t.getDate()+1),localStorage.expireTime=t.getTime(),localStorage.products=JSON.stringify(e.data),y(e.data)})},localStorage.products&&localStorage.expireTime&&Number(localStorage.expireTime)>(new Date).getTime()?n(function(){y(JSON.parse(localStorage.products))},0):e.getTradeLists(),e.selectProduct=function(e,t,r,a){window.location.replace("/exchange/"+PREFIX+"tradeDetail.html?symbol="+t)},e.Ischange=!1;var N;e.keyWords=[],e.getSymbols=function(){e.Ischange=!0;var t=/[\u4e00-\u9fa5]/g,r=e.searchKeyword;e.keyWords=[],e.index=0,r&&(t.test(r)?(N=0,e.keyWords=[],angular.forEach(e.products,function(t){if(t.name.match(r)){var a={};a.name=t.name,a.symbol=t.symbol,a.price=t.close,e.keyWords.push(a),N++}})):(N=0,e.keyWords=[],angular.forEach(e.products,function(t){if(t.symbol.substring(0,r.length).toLowerCase()==r.toLowerCase()){var a={};a.name=t.name,a.symbol=t.symbol,a.price=t.close,e.keyWords.push(a),N++}})))},e.index=0,e.selectList=function(t){var r=t||window.event||arguments.callee.caller.arguments[0];if(r&&N&&"38"==r.keyCode&&(0==e.index?e.index=N-1:e.index=e.index-1),r&&N&&"40"==r.keyCode&&(e.index==N-1?e.index=0:e.index=e.index+1),r&&"13"==r.keyCode){r&&r.preventDefault?r.preventDefault():window.event.returnValue=!1;var a=e.keyWords[e.index];e.Ischange&&(e.selectProduct(a.name,a.symbol,a.price),e.Ischange=!1)}},s.bind("keydown",function(t){e.$apply(function(){90==t.keyCode&&"dqwt"==e.sign?e.deleteAllOrderAsk():114==t.keyCode?(t.preventDefault(),e.sign="dqwt"):121==t.keyCode?e.tabName="cpxx":27==t.keyCode?window.location.href="/exchange/"+PREFIX+"index.html":t.ctrlKey&&t.shiftKey&&75==t.keyCode&&(p.bool=!0)})}),e.tab=function(t){if(e.sign=t,e.Islogin)switch(t){case"lswt":e.timeQuantum=0,e.getAllOrders(1,1e3,I,w);break;case"lscj":e.timeQuantum=0,e.getDealOrders(1,1e3,I,w)}},e.trade=function(t){e.buy_order.price=Number(t).toFixed(2),e.sell_order.sell_price=Number(t).toFixed(2)},e.buy_submit=function(){if(!chackRate())return void layer.msg("按钮点击频率太快",{icon:5,shift:1,time:700});var t=Number(e.buy_order.price),a=(t*e.buy_order.quantity,/^\+?[1-9][0-9]*$/),o=/^\d+(\.\d{0,2})?$/;if(!e.Islogin)return e.showLoginBox(EXCHANGE),!1;var n=Math.floor(e.free/(e.buy_order.price*(1+1*e.userBaseInfo.buyerCommission)));if(e.currentProduct){if(""==e.buy_order.price||null==e.buy_order.price)return layer.msg("请输入买入价",{icon:5,shift:1,time:500}),!1;if(!o.test(e.buy_order.price))return layer.msg("请输入正确的买入价",{icon:5,shift:1,time:500}),!1;if(""==e.buy_order.quantity||null==e.buy_order.quantity)return layer.msg("请输入买入量",{icon:5,shift:1,time:500}),angular.element("#buy_order").focus(),!1;if(a.test(e.buy_order.quantity)){if(Number(e.buy_order.quantity)>n)return angular.element("#buy_order").focus(),!1;if(t<Number(e.currentProduct.minPrice))return layer.msg("价格不能低于"+e.currentProduct.minPrice,{icon:5,shift:1,time:500}),!1;if(t>Number(e.currentProduct.maxPrice))return layer.msg("价格不能高于"+e.currentProduct.maxPrice,{icon:5,shift:1,time:500}),!1;var s=$.param({price:e.buy_order.price,quantity:e.buy_order.quantity,symbol:e.currentProduct.symbol,side:"BUY",type:"LIMIT"});e.buy_order.quantity="",r.post("private/order",s).then(function(e){layer.msg("下单成功",{icon:1,shift:1,time:500})},function(e){e.data.msg.toUpperCase().match("MARKET.*CLOSED")?layer.msg("下单失败:非交易时间不能下单!",{icon:5,shift:1,time:1e3}):e.data.msg.toUpperCase().match("INSUFFICIENT BALANCE")?layer.msg("下单失败:余额不足",{icon:5,shift:1,time:1e3}):e.data.msg.toUpperCase().match("Too MANY NEW ORDERS")?layer.msg("下单失败:下单过于频繁",{icon:5,shift:1,time:1e3}):layer.msg("下单失败: "+e.data.msg,{icon:5,shift:1,time:1e3})})}else layer.msg("买入量必须为整数",{icon:5,shift:1,time:500}),angular.element("#buy_order").val("").focus()}else layer.msg("请选择交易产品",{icon:5,shift:1,time:500}),angular.element("#searchKeyword").focus()},e.limitBuyOrder=function(){p.isClose(e.today,e.buy_submit)},e.sell_submit=function(){if(!chackRate())return void layer.msg("按钮点击频率太快",{icon:5,shift:1,time:700});var t=Number(e.sell_order.sell_price),a=Number(e.sell_order.sell_quantity),o=/^\+?[1-9][0-9]*$/,n=/^\d+(\.\d{0,2})?$/;if(!e.Islogin)return e.showLoginBox(EXCHANGE),!1;if(e.currentProduct){if(""==e.sell_order.sell_price||null==e.sell_order.sell_price)return layer.msg("请输入卖出价",{icon:5,shift:1,time:500}),!1;if(!n.test(e.sell_order.sell_price))return layer.msg("请输入正确的卖出价",{icon:5,shift:1,time:500}),!1;if(""==e.sell_order.sell_quantity||null==e.sell_order.sell_quantity)return layer.msg("请输入卖出量",{icon:5,shift:1,time:500}),angular.element("#sell_order").focus(),!1;if(!o.test(e.sell_order.sell_quantity))return layer.msg("卖出量必须为整数",{icon:5,shift:1,time:500}),angular.element("#sell_order").val("").focus(),!1;if(a>Number(e.currentUserAsset))return angular.element("#sell_order").focus(),!1;if(t<Number(e.currentProduct.minPrice))return layer.msg("价格不能低于"+e.currentProduct.minPrice,{icon:5,shift:1,time:500}),!1;if(t>Number(e.currentProduct.maxPrice))return layer.msg("价格不能高于"+e.currentProduct.maxPrice,{icon:5,shift:1,time:500}),!1;var s=$.param({price:e.sell_order.sell_price,quantity:e.sell_order.sell_quantity,symbol:e.currentProduct.symbol,side:"SELL",type:"LIMIT"});e.sell_order.sell_quantity="",r.post("private/order",s).then(function(e){layer.msg("下单成功",{icon:1,shift:1,time:500})},function(e){e.data.msg.toUpperCase().match("MARKET.*CLOSED")?layer.msg("下单失败:非交易时间不能下单!",{icon:5,shift:1,time:500}):e.data.msg.toUpperCase().match("INSUFFICIENT BALANCE")?layer.msg("下单失败:余额不足",{icon:5,shift:1,time:500}):e.data.msg.toUpperCase().match("Too MANY NEW ORDERS")?layer.msg("下单失败:下单过于频繁",{icon:5,shift:1,time:1e3}):layer.msg("下单失败: "+e.data.msg,{icon:5,shift:1,time:500})})}else layer.msg("请选择交易产品",{icon:5,shift:1,time:500}),angular.element("#searchKeyword").focus()},e.limitSellOrder=function(){p.isClose(e.today,e.sell_submit)},e.market_buy_submit=function(){if(!chackRate())return void layer.msg("按钮点击频率太快",{icon:5,shift:1,time:700});var t=/^\+?[1-9][0-9]*$/;if(!e.Islogin)return e.showLoginBox(EXCHANGE),!1;if(e.currentProduct){if(""==e.market_buy_order.market_buy_quantity||null==e.market_buy_order.market_buy_quantity)return layer.msg("请输入买入量",{icon:5,shift:1,time:500}),angular.element("#marketbuyqun").focus(),!1;if(!t.test(e.market_buy_order.market_buy_quantity))return layer.msg("买入量必须为整数",{icon:5,shift:1,time:500}),angular.element("#marketbuyqun").val("").focus(),!1;var a=$.param({quantity:e.market_buy_order.market_buy_quantity,symbol:e.currentProduct.symbol,side:"BUY",type:"MARKET"});e.market_buy_order.market_buy_quantity="",r.post("private/order",a).then(function(e){layer.msg("下单成功",{icon:1,shift:1,time:500})},function(e){e.data.msg.toUpperCase().match("MARKET.*CLOSED")?layer.msg("下单失败:非交易时间不能下单!",{icon:5,shift:1,time:1e3}):e.data.msg.toUpperCase().match("INSUFFICIENT BALANCE")?layer.msg("下单失败:余额不足",{icon:5,shift:1,time:1e3}):e.data.msg.toUpperCase().match("Too MANY NEW ORDERS")?layer.msg("下单失败:下单过于频繁",{icon:5,shift:1,time:1e3}):layer.msg("下单失败: "+e.data.msg,{icon:5,shift:1,time:1e3})})}else layer.msg("请选择交易产品",{icon:5,shift:1,time:500}),angular.element("#searchKeyword").focus()},e.marketBuyOrder=function(){p.isClose(e.today,e.market_buy_submit)},e.market_sell_submit=function(){if(!chackRate())return void layer.msg("按钮点击频率太快",{icon:5,shift:1,time:700});var t=/^\+?[1-9][0-9]*$/;if(!e.Islogin)return e.showLoginBox(EXCHANGE),!1;if(e.currentProduct){if(""==e.market_sell_order.market_sell_quantity||null==e.market_sell_order.market_sell_quantity)return layer.msg("请输入卖出量",{icon:5,shift:1,time:500}),angular.element("#market_sell").focus(),!1;if(!t.test(e.market_sell_order.market_sell_quantity))return layer.msg("卖出量必须为整数",{icon:5,shift:1,time:500}),angular.element("#market_sell").val("").focus(),!1;if(Number(e.market_sell_order.market_sell_quantity)>Number(e.currentUserAsset))return angular.element("#market_sell").focus(),!1;var a=$.param({quantity:e.market_sell_order.market_sell_quantity,symbol:e.currentProduct.symbol,side:"SELL",type:"MARKET"});e.market_sell_order.market_sell_quantity="",r.post("private/order",a).then(function(e){layer.msg("下单成功",{icon:1,shift:1,time:500})},function(e){return e.data.code==-2010?(layer.msg("持仓不足",{icon:5,shift:1,time:1e3}),!1):void layer.msg("下单失败: "+e.data.msg,{icon:5,shift:1,time:1e3})})}else layer.msg("请选择交易产品",{icon:5,shift:1,time:500}),angular.element("#searchKeyword").focus()},e.marketSellOrder=function(){p.isClose(e.today,e.market_sell_submit)},e.getNewest=function(){r.get(k+"/trades?limit=1&symbol="+e.product.symbol).success(function(t){0!=t.length&&(e.newest=Number(t[0].price),e.buy_order.price=Number(t[0].price),e.buy_order.price=Number(t[0].price).toFixed(2),e.sell_order.sell_price=Number(t[0].price).toFixed(2))})},e.getNewest(),e.deleteOrder=function(e,t){var a=$.param({orderId:e,symbol:t});r.post("private/deleteOrder",a).then(function(e){layer.msg("撤销成功！",{icon:1,shift:1,time:500})},function(e){layer.msg("撤单失败: "+e.data.msg,{icon:5,shift:1,time:500})})},e.deleteAllOrder=function(){"dqwt"==e.sign&&angular.forEach(e.openOrders,function(t){e.deleteOrder(t.orderId,t.symbol)})},e.deleteAllOrderAsk=function(){if(0!=e.openOrders.length)var t=layer.confirm('<p style="font-size:16px;color:#c3c3c3;font-family:NSimSun;text-align: center;margin-top: 18px;height:60px">您确定要撤销全部委托吗？</p>',{shade:.8,skin:"confirm-class",closeBtn:!1,area:["325px","170px"],title:!1,btn:["确定","取消"]},function(){e.deleteAllOrder(e.openOrders)},function(){layer.close(t)})};var D=function(e){switch(e+""){case"0":return"1m";case"60":return"1m";case"180":return"3m";case"300":return"5m";case"900":return"15m";case"1800":return"30m";case"3600":return"1h";case"7200":return"2h";case"14400":return"4h";case"21600":return"6h";case"43200":return"12h";case"86400":return"1d";case"259200":return"3d";case"604800":return"1w"}console.log("Error parsing resolution: "+e)},x="60",O=D(x);RTBTC.instrument("BIJIE",e.product.symbol,"CNY");var P={t:Number(x),icontrols:!0,i:[{m:!0,p:0,h:50,u:[],o:[]},{m:!1,t:"vol",i:null,p:5,h:10,r:[]},{m:!1,t:"macd",i:null,p:5,h:10,r:[]}]};window.chart=(new Chart).build("#chart",null,P),chart.showDetail();var E=angular.element(window).height(),A=angular.element(".header").outerHeight(!0),C=angular.element(".detail-lb").outerHeight(!0);angular.element(".box-inner").css({height:E-A-C,"max-height":E-A-75}),window.UserAccount=UserAccount_Class.Build();var M=(new VisualDepth).build("#depth",$("#p"));e.trades=[],e.todayTrades=[],e.streamBids={},e.streamBidsKeys=[],e.streamAsks={},e.streamAsksKeys=[];var R=function(t){if("depthUpdate"==t.eventType){console.log(t.bids),t.bids.forEach(function(t){var r=Number(t[0]),a=Number(t[1]);0!=a?e.streamBids[r]=a:delete e.streamBids[r]}),t.asks.forEach(function(t){var r=Number(t[0]),a=Number(t[1]);0!=a?e.streamAsks[r]=a:delete e.streamAsks[r]}),OBD.loadBook(e.streamAsks,e.streamBids),e.streamBidsKeys=Object.keys(e.streamBids).sort(function(e,t){return e-t}).reverse(),e.streamAsksKeys=Object.keys(e.streamAsks).sort(function(e,t){return e-t});var r=0,a=0;angular.forEach(e.streamBidsKeys,function(t){r+=Number(e.streamBids[t])}),angular.forEach(e.streamAsksKeys,function(t){a+=Number(e.streamAsks[t])}),e.committeeDifference=r-a,e.commissionRatio=100*(r-a)/(r+a);var o=[],n=[];if(angular.forEach(e.streamBidsKeys.slice(0,20),function(t){o.push([Number(t).toFixed(2),Number(e.streamBids[t]).toFixed(0)])}),o.length<20)for(var s=o.length;s<20;)o.push(["--","--"]),++s;if(angular.forEach(e.streamAsksKeys.slice(0,20),function(t){n.push([Number(t).toFixed(2),Number(e.streamAsks[t]).toFixed(0)])}),n.length<20)for(var s=n.length;s<20;)n.push(["--","--"]),++s;!isNaN(Number(o[0][0]))&&!isNaN(Number(n[0][0]))&&Number(o[0][0])>=Number(n[0][0])&&$("#netbad1").show(),e.bidsTwenty=o,e.asksTwenty=n.reverse()}else if("trade"==t.eventType){if(t.price=Number(t.price).toFixed(2),t.qty=Number(t.qty).toFixed(0),0==e.trades.length||e.trades[0].tradeId<t.tradeId){e.trades.unshift(t);var i=Math.ceil(e.trades.length/3);e.todayTrades=[e.trades.slice(0,i),e.trades.slice(i,2*i),e.trades.slice(2*i)]}if(e.newestQty=t.qty,e.currentProduct.lastTradeId>=t.tradeId)return;t.isBuyerMaker?e.currentProduct.activeSell+=Number(t.qty):e.currentProduct.activeBuy+=Number(t.qty),e.currentProduct.tradedMoney+=t.price*t.qty,e.currentProduct.lastTradeId=t.tradeId,e.newest=t.price,void 0!=e.currentProduct&&(e.newest>=e.currentProduct.prevClose?(e.isIncrease=!0,e.Dvalue="+"+(e.newest-e.currentProduct.prevClose),e.Dpercent="+"+(e.Dvalue/e.currentProduct.prevClose*100).toFixed(2)):(e.isIncrease=!1,e.Dvalue=e.newest-e.prevClose,e.Dpercent=(e.Dvalue/e.prevClose*100).toFixed(2)))}else if("kline"==t.eventType){if("1d"==t.kline.interval)e.streamKline=t.kline,void 0!=e.currentProduct&&(e.currentProduct.open=t.kline.open,e.currentProduct.high=t.kline.high,e.currentProduct.low=t.kline.low,e.currentProduct.volume=t.kline.volume),console.log(e.streamKline);else if("1m"==t.kline.interval){var l=t.kline.time,c=new Date(l),u=c.getFullYear(),d=c.getMonth(),m=c.getDate(),p=c.getHours(),g=c.getMinutes(),f=new Date(u,d,m,9,30,0),h=f.getTime(),y=new Date(u,d,m,11,30,0),b=y.getTime(),v=new Date(u,d,m,13,0,0),k=v.getTime(),I=new Date(u,d,m,15,0,0),w=I.getTime();if(l<h){var S=0;e.volumeRatio=""}else if(l>=h&&l<=b){var S=60*(p-9)+g-30,T=e.currentProduct.avgQty/240,_=e.currentProduct.volume/S;0==T?e.volumeRatio="":e.volumeRatio=_/T}else if(l>b&&l<=k){var S=120,T=e.currentProduct.avgQty/240,_=e.currentProduct.volume/S;0==T?e.volumeRatio="":e.volumeRatio=_/T}else if(l>=k&&l<=w){var S=60*(p-13+2)+g,T=e.currentProduct.avgQty/240,_=e.currentProduct.volume/S;0==T?e.volumeRatio="":e.volumeRatio=_/T}else if(l>=w){var S=240,T=e.currentProduct.avgQty/240,_=e.currentProduct.volume/S;0==T?e.volumeRatio="":e.volumeRatio=_/T}}t.kline.interval==O&&Data.onBar([t.kline.time,Number(t.kline.open),Number(t.kline.high),Number(t.kline.low),Number(t.kline.close),Number(t.kline.volume)],Number(x))}else console.log("Error! Bad data received:"),console.log(t);var N=e.$root.$$phase;"$apply"!=N&&"$digest"!=N&&e.$apply()},L=!0,F=function(e,t){t?(L||(chart.fixTime(!1),chart.setBarwidth(9),chart.clearData(),chart.removeIndicatorByname(["avl"]),chart.addOverlay("ema",5),chart.addOverlay("ema",10),chart.setMode("Candle"),L=!0),x=e,O=D(x),chart.setResolution(Number(e))):(L&&(chart.fixTime(!0),chart.clearData(),chart.setLastColorIndex(0),chart.removeIndicatorByname(["ema","ema"]),chart.addOverlay("avl"),chart.setMode("Line"),L=!1),x="60",O=D(x),chart.setResolution(60))};e.chartLoaded=function(){return e.wssUrl?(e.loaded=!0,void e.connectToKlineStreamer(e.wssUrl)):void n(function(){e.chartLoaded()},0)};var B,U="-1";Data.onLoaded(function(){U!=B&&(e.chartLoaded(),B=U)}),e.getByInterval=function(t,r){U!=r&&(F(t,!0),e.curIndex=r,U=r,localStorage.curIndex=r)},e.clickmax=function(){e.buy_order.price=e.currentProduct.maxPrice,e.sell_order.sell_price=e.currentProduct.maxPrice},e.clickmin=function(){e.buy_order.price=e.currentProduct.minPrice,e.sell_order.sell_price=e.currentProduct.minPrice},e.setTimeLine=function(t){U!=t&&(F("0",!1),e.curIndex=t,localStorage.curIndex=t,U=t)},parseInt(e.curIndex)?(L=!1,e.getByInterval(S[parseInt(e.curIndex)],parseInt(e.curIndex))):(L=!0,e.curIndex=0,e.setTimeLine(e.curIndex)),e.curzb="MACD",e.jszbLists=!1,e.toggleJszbLists=function(){e.jszbLists=!e.jszbLists},e.setIndicator=function(t){e.removeIndicator(),e.curzb=t,"MACD"==t?chart.addOrUpdateIndicator("macd"):"TRIX"==t?chart.addOrUpdateIndicator("trix"):"KDJ"==t?chart.addOrUpdateIndicator("kdj"):"BRAR"==t||("StochRSI"==t?chart.addOrUpdateIndicator("storsi"):"VR"==t||("RSI"==t?chart.addOrUpdateIndicator("rsi"):"EMV"==t?chart.addOrUpdateIndicator("emv"):"DMI"==t?chart.addOrUpdateIndicator("dmi"):"WR"==t?chart.addOrUpdateIndicator("wpr"):"OBV"==t?chart.addOrUpdateIndicator("obv"):"ROC"==t||("BOLL"==t?chart.addOrUpdateIndicator("bnd"):"MTM"==t?chart.addOrUpdateIndicator("mtm"):"SAR"==t?chart.addOrUpdateIndicator("psar"):"EMA"==t?chart.addOrUpdateIndicator("ema"):"PSY"==t||("CCI"==t?chart.addOrUpdateIndicator("cci"):"VWAP"==t&&chart.addOrUpdateIndicator("vwap"))))),e.jszbLists=!1},e.removeIndicator=function(){var t=e.curzb;"MACD"==t?chart.removeIndicatorByname(["macd"]):"TRIX"==t?chart.removeIndicatorByname(["trix"]):"KDJ"==t?chart.removeIndicatorByname(["kdj"]):"BRAR"==t||("StochRSI"==t?chart.removeIndicatorByname(["storsi"]):"VR"==t||("RSI"==t?chart.removeIndicatorByname(["rsi"]):"EMV"==t?chart.removeIndicatorByname(["emv"]):"DMI"==t?chart.removeIndicatorByname(["dmi"]):"WR"==t?chart.removeIndicatorByname(["wpr"]):"OBV"==t?chart.removeIndicatorByname(["obv"]):"ROC"==t||("BOLL"==t?chart.removeIndicatorByname(["bnd"]):"MTM"==t?chart.removeIndicatorByname(["mtm"]):"SAR"==t?chart.removeIndicatorByname(["psar"]):"EMA"==t?chart.removeIndicatorByname(["ema"]):"PSY"==t||("CCI"==t?chart.removeIndicatorByname(["cci"]):"VWAP"==t&&chart.removeIndicatorByname(["vwap"]))))),e.curzb=""},e.getBestTwenty=function(){r.get("public/bestN?limit=20&symbol="+e.product.symbol).success(function(t){var r=[],a=[],o=0;angular.forEach(t.bids,function(e){o+=parseFloat(e[1]),r.push([Number(e[0]).toFixed(2),Number(e[1]).toFixed(0),Number(o).toFixed(0)])});var n=0;angular.forEach(t.asks,function(e){n+=parseFloat(e[1]),a.push([Number(e[0]).toFixed(2),Number(e[1]).toFixed(0),Number(n).toFixed(0)])}),e.bids=r,e.asks=a})},e.getTodayTrades=function(){r.get("public/todayTrades?symbol="+e.product.symbol).success(function(t){e.trades=[],angular.forEach(t,function(t){t.price=Number(t.price).toFixed(2),t.qty=Number(t.qty).toFixed(0),e.trades.unshift(t)}),t.length>0&&(e.newest=t[0].price);Math.ceil(t.length/3)})},e.disconnect=function(){e.streamerInstance.stopStream(),e.streamerInstance=null},e.connectToSymbol=function(t){null==e.streamerInstance&&(e.streamerInstance=new c,e.streamerInstance.startStream(e.product.symbol,t,function(t){"depthUpdate"==t.eventType&&1==e.stopDepthStream||R(t)}))},e.connectToKlineStreamer=function(t){e.klineStreamer=null,e.klineStreamer=new h,e.klineStreamer.startStream(e.product.symbol,t,D(x),function(e){R(e)})},e.userCallback=function(t,r){if("outboundAccountInfo"==t.eventType){var a=t.balances;a.forEach(function(t){"CNY"==t.asset&&(e.locked=t.locked,e.free=t.free)})}if("executionReport"==t.eventType){var o={};switch(o.time=t.time,o.symbol=t.symbol,o.side=t.side,o.type=t.orderType,o.status=t.orderStatus,o.origQty=parseInt(t.qty),o.price=parseFloat(t.price),o.stopPrice=parseFloat(t.stopPrice),o.executedQty=parseInt(t.cummulativeQty),o.orderId=t.orderId,r.forEach(function(e){e.symbol==t.symbol&&(o.productName=e.name)}),t.orderStatus){case"NEW":o.executedQty=0,o.avgPrice=0,console.log(o.symbol+" 委托"+o.origQty),e.openOrders.splice(0,0,o),e.IsopenOrdersNull=!1,e.IsopenOrdersNull=!1,"SELL"==o.side&&e.userAssets instanceof Array&&e.userAssets.forEach(function(t){t.productSymbol==o.symbol&&(t.locked=parseFloat(t.locked)+o.origQty,t.free=parseFloat(t.free)-o.origQty,e.currentUserAsset=t.free)}),e.IsopenOrdersNull=!1;break;case"PARTIALLY_FILLED":var n=parseInt(t.lastQty),s=parseFloat(t.lastPrice),i=parseFloat(t.cummulativeQty);e.openOrders instanceof Array&&e.openOrders.forEach(function(e){e.symbol==o.symbol&&e.orderId==o.orderId&&(e.avgPrice=(e.executedQty*e.avgPrice+s*n)/i,e.executedQty=i,e.status="PARTIALLY_FILLED")});var l={};l.symbol=t.symbol,l.time=t.time,l.side=t.side,l.qty=t.lastQty,l.price=t.lastPrice,l.productName=o.productName,l.fee=t.commission,e.dealOrders.splice(0,0,l),e.dealBigTotalItems=e.dealOrders.length,e.updatePosition(o,n,s,parseFloat(l.fee));break;case"FILLED":var c,u=parseInt(t.lastQty),d=parseFloat(t.lastPrice),m=parseFloat(t.cummulativeQty);console.log(t),e.openOrders instanceof Array&&e.openOrders.forEach(function(e){e.symbol==o.symbol&&e.orderId==o.orderId&&(e.avgPrice=(e.executedQty*e.avgPrice+d*u)/m,e.executedQty=m,e.status="FILLED",c=e)});var p={};p.symbol=o.symbol,p.time=o.time,p.side=o.side,p.qty=u,p.price=d;var g=parseFloat(t.commission);p.fee=g,p.productName=o.productName,e.dealOrders.splice(0,0,p),e.dealBigTotalItems=e.dealOrders.length;var f;e.openOrders.forEach(function(e,t){e.symbol==o.symbol&&e.orderId==o.orderId&&(f=t)}),e.allOrders.splice(0,0,c),0==e.allOrders.length?e.IsallOrdersNull=!0:e.IsallOrdersNull=!1,e.openOrders.splice(f,1),0==e.openOrders.length?e.IsopenOrdersNull=!0:e.IsopenOrdersNull=!1,e.updatePosition(o,u,d,parseFloat(g));break;case"CANCELED":case"EXPIRED":"SELL"==o.side&&e.userAssets instanceof Array&&e.userAssets.forEach(function(t){t.productSymbol==o.symbol&&(t.locked=parseFloat(t.locked)-o.origQty+o.executedQty,t.free=parseFloat(t.free)+o.origQty-o.executedQty,e.currentUserAsset=t.free)});var h;e.openOrders.forEach(function(e,t){e.symbol==o.symbol&&e.orderId==o.orderId&&(h=t)}),e.openOrders.splice(h,1),0==e.openOrders.lenght?e.IsopenOrdersNull=!0:e.IsopenOrdersNull=!1,e.allOrders.splice(0,0,o),0==e.allOrders.length?e.IsallOrdersNull=!0:e.IsallOrdersNull=!1}e.totalMarketValue=0,e.cost=0,e.userAssets.forEach(function(t,r){t.price&&(e.totalMarketValue+=Number(t.price)*(Number(t.free)+Number(t.freeze)+Number(t.locked)+Number(t.withdrawing)),e.cost+=Number(t.cost))}),e.totalProfit=e.totalMarketValue-e.cost}var y=e.$root.$$phase;"$apply"!=y&&"$digest"!=y&&e.$apply()},e.updatePosition=function(t,r,a,o){var n,s;if(e.userAssets instanceof Array&&e.userAssets.forEach(function(e,r){e.productSymbol==t.symbol&&(n=e,s=r)}),n)"BUY"==t.side?(n.freeze=parseFloat(n.freeze),n.cost=parseFloat(n.cost),n.free=parseFloat(n.free)+r,n.cost=parseFloat(n.cost)+r*a+o,n.costPrice=n.cost/(n.free+n.locked+n.freeze),n.price=a,n.marketValue=a*(n.free+n.locked+n.freeze),n.profitLoss=n.marketValue-n.cost,n.percent=100*n.profitLoss/n.cost):"SELL"==t.side&&(n.locked=parseFloat(n.locked).toFixed(2),n.locked-=r,0==n.free&&0==n.locked&&0==n.freeze&&0==n.ipoing&&0==n.ipoable&&0==n.storage?e.userAssets.splice(s,1):(n.freeze=parseFloat(n.freeze),n.cost=parseFloat(n.cost),n.cost-=r*a-o,n.costPrice=n.cost/(n.free+n.locked+n.freeze),n.price=a,n.marketValue=a*(n.free+n.locked+n.freeze),n.profitLoss=n.marketValue-n.cost,n.percent=100*n.profitLoss/n.cost)),e.currentUserAsset=n.free;else if("BUY"==t.side){var i={};i.productSymbol=t.symbol,i.productName=t.productName,i.free=r,i.locked=0,i.freeze=0,i.ipoing=0,i.ipoable=0,i.storage=0,i.cost=r*a+o,i.costPrice=a,i.price=a,i.marketValue=r*a,i.profitLoss=-o,i.percent=100*i.profitLoss/i.cost,e.userAssets.splice(0,0,i),e.currentUserAsset=i.free}0==e.userAssets.length&&(e.totalMarketValue=0,e.totalProfit=0)},r.get("/exchange/public/productSnapshot?symbol="+e.product.symbol).success(function(t){"false"==t?e.stopDepthStream=!1:(e.stopDepthStream=!0,r.get("/exchange/public/depthSnapshot?symbol="+e.product.symbol).success(function(e){e.eventType="depthUpdate",R(e)})),window.WebSocket?r.get("public/wssUrl").success(function(t){e.wssUrl=t,e.connectToSymbol(t)}):a(function(){e.getNewest(),e.getBestTwenty(),e.getTodayTrades()},1e3)}),e.getUserInfo=function(t){if(window.WebSocket){var o={};o.method="post",o.url="/exchange/private/startStream",r(o).success(function(o){r.get("public/wssUrl").success(function(n){var s=n+"/"+o.listenKey;a(function(){r({url:"/exchange/private/pingStream",method:"post",data:"listenKey="+o.listenKey}).success(function(){console.log("pingStream success")})},18e5),null==e.userStreamerInstance&&(e.userStreamerInstance=new m,e.userStreamerInstance.startStream(s,function(r){console.log("##################"),e.userCallback(r,t)}))})})}},e.isFull=!1;var q=angular.element("#klinecon"),z=angular.element("#chart_container"),K=angular.element(window).height();e.setlayout=function(){var t=angular.element(window).height(),r=angular.element(".header").outerHeight(!0),a=angular.element(".detail-lb").outerHeight(!0),o=angular.element(".detail-rb").outerHeight(!0),n=angular.element("#trade-wb").outerHeight(!0),s=angular.element("#trade-zt").outerHeight(!0),i=angular.element(".kline-item").outerHeight(!0),l=angular.element(".table.para").outerHeight(!0);angular.element(".detail-lt").css({height:t-r-a,"max-height":t-r-42}),angular.element(".detail-rt").css("height",t-r-o),angular.element(".newtrade").css("height",t-r-o-l),angular.element(".tradefive-inner").css("height",(t-r-o-n-i-s)/2),"kline"==e.tabName&&(console.log(12),z.css({height:t-r-a-33,"max-height":t-r-75}),chart.resize()),"depth"==e.tabName&&(angular.element(".box-inner").css({height:t-r-a,"max-height":t-r-75}),M.resize())},e.fullpage=function(){e.isFull=!0,q.css({position:"fixed",top:"0px",left:"0px",width:"100%",height:"100%","z-index":99}),z.css({width:"100%",height:K-33+"px","max-height":K-33+"px"}),chart.resize()},e.offFullpage=function(){e.isFull=!1,q.css({position:"static"}),e.setlayout()},window.onload=function(){e.setlayout(),z.width(q.width()),chart.resize(),angular.element("input").attr("autocomplete","off")},window.onresize=function(){z.width(q.width()),e.setlayout()};var Q=!1,W=0;$(".handle").mousedown(function(t){Q=!0,W=t.clientY;var r=$(".detail-lt").height(),a=$(".detail-lb").height();return $(document).mousemove(function(t){if(Q){var o=t.clientY-W;$(".detail-lt").css("height",r+o+"px"),$(".detail-lb").css("height",a-o+"px"),"kline"==e.tabName&&($("#chart_container").css("height",r+o-33+"px"),chart.resize()),"depth"==e.tabName&&($(".box-inner").css("height",r+o-3+"px"),M.resize())}}),!1}),$(document).mouseup(function(){Q=!1})}]);app.factory("klineStreamer",["$http","$interval",function(e,t){return function(){var e={};return e.isRunning=!1,e.restart=!1,e.lastTradeId=-1,e.root_url=location.host.match("localhost")||location.host.match("192.168.0")?"/exchange/public":"/api/v1",e.startStream=function(t,r,a,o){e.isRunning=!0,e.url=r,e.interval=a,e.lastDepthId=-2,e.lastKlineId=-1,e.backedMsg=[],e.buildingState=!1,e.restart=!0,e.symbol=t,e.lowerCaseSymbol=t.toLowerCase(),e.processData=function(t){e._isDuplicate(t)||o(t)},e.ws?e.ws.close():e.ws=e._makeStream()},e.stopStream=function(){e.restart=!1,e.ws&&e.ws.close(),e.lastDepthId=-1,e.lastKlineId=-1,e.backedMsg=[],e.buildingState=!0,e.isRunning=!1},e._rolloverStream=function(){console.log("Rolling over stream!"),e.backedMsg=[],e.buildingState=!0,e.ws=e._makeStream()},e._makeStream=function(){
var t=new WebSocket(e.url+"/"+e.lowerCaseSymbol+"_"+e.interval+".b10");return t.onopen=function(){console.log("Socket has been opened for: "+e.symbol+"!")},t.onclose=function(t){console.log("Socket has been CLOSED for: "+e.symbol+"!"),e.restart?e._rolloverStream():(delete e.ws,console.log("Socket done!"))},t.onmessage=function(t){var r=JSON.parse(t.data);r=e.converter(r),console.log("WS recv: "+r.eventType),e.buildingState?(e.backedMsg.push(r),console.log("Adding msg to backlog: "+r.eventType)):e.processData(r)},t},e.converter=function(e){var t={};return t.eventType=e.e,t.eventTime=e.E,t.symbol=e.s,t.kline={},t.kline.time=e.k.t,t.kline.closeTime=e.k.T,t.kline.symbol=e.k.s,t.kline.interval=e.k.i,t.kline.firstId=e.k.f,t.kline.lastId=e.k.L,t.kline.open=e.k.o,t.kline.close=e.k.c,t.kline.high=e.k.h,t.kline.low=e.k.l,t.kline.volume=e.k.v,t.kline.count=e.k.n,t.kline.closed=e.k.x,t},e._isDuplicate=function(e){return"kline"!=e.eventType&&(console.log("Error! Bad data received:"),console.log(e),!0)},e}}]),app.factory("mktdataStreamer",["$http","$interval",function(e,t){return function(){var e={};return e.isRunning=!1,e.restart=!1,e.startStream=function(t,r){e.isRunning=!0,e.url=t,e.lastTradeIds={},e.backedMsg=[],e.buildingState=!0,e.restart=!0,e.processData=function(t){e._isDuplicate(t)||r(t)},e.ws?e.ws.close():e.ws=e._makeStream()},e.stopStream=function(){e.restart=!1,e.ws&&e.ws.close(),e.lastTradeIds={},e.backedMsg=[],e.buildingState=!0,e.isRunning=!1},e._rolloverStream=function(){console.log("Rolling over stream!"),e.backedMsg=[],e.buildingState=!0,e.ws=e._makeStream()},e._makeStream=function(){var t=new WebSocket(e.url+"/!mktdata.b10");return t.onopen=function(){console.log("Socket has been opened for: market data!"),e._buildState()},t.onclose=function(t){console.log("Socket has been CLOSED for: market data!"),e.restart?e._rolloverStream():(delete e.ws,console.log("Socket done!"))},t.onmessage=function(t){var r=JSON.parse(t.data);r=e.converter(r),console.log("Market data WS recv, symbol: "+r.symbol+", tradeId: "+r.tradeId),e.buildingState?(e.backedMsg.push(r),console.log("Adding msg to backlog: "+r.eventType)):e.processData(r)},t},e._buildState=function(){e.buildingState=!1},e.converter=function(e){var t={};return t.eventType=e.e,t.eventTime=e.E,t.symbol=e.s,t.tradeId=e.t,t.price=e.p,t.qty=e.q,t.buyerOrderId=e.b,t.sellerOrderId=e.a,t.time=e.T,t.isBuyerMaker=e.m,t},e._isDuplicate=function(t){return"trade"!=t.eventType||!(void 0==e.lastTradeIds[t.symbol]||e.lastTradeIds[t.symbol]<t.tradeId)||(e.lastTradeIds[t.symbol]=t.tradeId,!1)},e}}]),app.factory("user",["$http","$cookies",function(e,t){var r={};return r.logout=function(){var t={method:"post",url:"/user/loginOut.html"};e(t).success(function(e){if(e.success){var t=new Date;t.setTime(t.getTime()-1e3),document.cookie="logined=;path=/;expires="+t.toGMTString(),window.location.href="/index.html"}})},r.login=function(e){layer.open({type:2,title:"用户登录",shadeClose:!0,shade:.8,shift:1,area:["423px","350px"],content:["/"+e+"_loginbox.html","no"]})},r}]),app.factory("myDate",function(){var e=new Date,t=e.getFullYear(),r=e.getMonth(),a=e.getDate(),o={};return o.firstOfMonth=new Date(t,r,1,0,0,0).getTime(),o.currentTime=e.getTime(),o.today=new Date(t,r,a,0,0,0),o.tomorrow=new Date(t,r,a+1,0,0,0),o.timePointFirst=new Date(t,r,a,9,30,0).getTime(),o.timePointSecond=new Date(t,r,a,11,30,0).getTime(),o.timePointThird=new Date(t,r,a,13,0,0).getTime(),o.timePointFourth=new Date(t,r,a,15,0,0).getTime(),o}),app.factory("getRequest",function(){var e=location.search,t=new Object;if(e.indexOf("?")!=-1)for(var r=e.substr(1),a=r.split("&"),o=0;o<a.length;o++)t[a[o].split("=")[0]]=unescape(a[o].split("=")[1]);return t}),app.factory("layout",function(){var e={};return e.set=function(){var e=angular.element(".header").outerHeight(!0),t=angular.element(".tradelist-main-bottom").outerHeight(!0),r=angular.element(window).height();angular.element(".tradelist-main-top").css({height:r-e-t,"max-height":r-e-t}),angular.element(".list-table").css({height:r-e-t-64,"max-height":r-e-t-64})},e}),app.factory("exchangeDate",function(){var e=new Date,t=e.getFullYear(),r=e.getMonth(),a=e.getDate(),o={};return o.bool=!1,o.timePointFirst=new Date(t,r,a,9,29,50).getTime(),o.timePointSecond=new Date(t,r,a,11,30,10).getTime(),o.timePointThird=new Date(t,r,a,12,59,50).getTime(),o.timePointFourth=new Date(t,r,a,15,0,10).getTime(),o.isClose=function(e,t){o.bool?t():e>=o.timePointFirst&&e<=o.timePointSecond||e>=o.timePointThird&&e<=o.timePointFourth?t():layer.msg("下单失败:非交易时间不能下单!",{icon:5,shift:1,time:1e3})},o}),app.factory("myInterceptor",["$q","$cookies",function(e,t){var r={request:function(e){return e.headers={"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},t.CSRFToken&&(e.headers.CSRFToken=$.md5(t.CSRFToken)),e},response:function(e){return e},requestError:function(t){return e.reject(t)},responseError:function(t){if(console.log(t),401==t.status){var r=new Date;r.setTime(r.getTime()-1e3),t=JSON.stringify(t),localStorage.setItem("temp2",t),typeof localStorage.getItem("temp2"),localStorage.getItem("temp2"),localStorage.a=document.cookie,document.cookie="logined=;path=/;expires="+r.toGMTString(),location.href="/"+PREFIX+"login.html?callback="+encodeURIComponent(location.pathname)+encodeURIComponent(location.search)}return e.reject(t)}};return r}]),app.factory("streamer",["$http","$interval",function(e,t){return function(){var t={};return t.isRunning=!1,t.restart=!1,t.lastTradeId=-1,t.root_url=location.host.match("localhost")||location.host.match("192.168.0")?"/exchange/public":"/api/v1",t.startStream=function(e,r,a){t.isRunning=!0,t.url=r,t.lastDepthId=-2,t.lastKlineId=-1,t.backedMsg=[],t.buildingState=!0,t.restart=!0,t.symbol=e,t.lowerCaseSymbol=e.toLowerCase(),t.processData=function(e){t._isDuplicate(e)||a(e)},t.ws?t.ws.close():t.ws=t._makeStream()},t.stopStream=function(){t.restart=!1,t.ws&&t.ws.close(),t.lastDepthId=-1,t.lastKlineId=-1,t.backedMsg=[],t.buildingState=!0,t.isRunning=!1},t._rolloverStream=function(){console.log("Rolling over stream!"),t.backedMsg=[],t.buildingState=!0,t.ws=t._makeStream()},t._makeStream=function(){var e=new WebSocket(t.url+"/"+t.lowerCaseSymbol+".b10");return e.onopen=function(){console.log("Socket has been opened for: "+t.symbol+"!"),t._buildState()},e.onclose=function(e){console.log("Socket has been CLOSED for: "+t.symbol+"!"),t.restart?t._rolloverStream():(delete t.ws,console.log("Socket done!"))},e.onmessage=function(e){var r=JSON.parse(e.data);console.log("WS recv: "+r.eventType),r=t.converter(r),t.buildingState?(t.backedMsg.push(r),console.log("Adding msg to backlog: "+r.eventType)):t.processData(r)},e},t._buildState=function(){var r={};r.method="get",r.url=t.root_url+"/depth",r.params={symbol:t.symbol};var a={};a.method="get",a.url="/exchange/public/todayTrades",a.params={symbol:t.symbol,tradeId:t.lastTradeId+1},e(r).success(function(r){e(a).success(function(e){var a={};a.eventType="depthUpdate",a.updateId=r.lastUpdateId,a.bids=r.bids,a.asks=r.asks,t.lastKlineId=-1,t.processData(a);for(var o=0;o<e.length;o++){var n={};n.eventType="trade",n.tradeId=e[o].id,n.price=e[o].price,n.qty=e[o].qty,n.time=e[o].time,n.isBuyerMaker=e[o].isBuyerMaker,n.buyerOrderId=-1,n.sellerOrderId=-1,t.processData(n)}console.log("Initial state set!"),console.log("Replaying "+t.backedMsg.length+" backed msgs!");for(var s=t.backedMsg.shift();s;)t.processData(s),console.log("Replayed: "+s.eventType),s=t.backedMsg.shift();if(t.buildingState=!1,console.log("Replaying DONE! "+t.backedMsg.length+" backed msgs remain."),0!=t.backedMsg.length)for(console.log("OMG!! ME SMASH!!! GIVE ME A REAL THREADING MODEL PLEASE!!"),s=t.backedMsg.shift();s;)t.processData(s),s=t.backedMsg.shift()})})},t.converter=function(e){var t={};return t.eventType=e.e,t.eventTime=e.E,t.symbol=e.s,t.kline=e.k,"depthUpdate"==t.eventType?(t.event=e.e,t.eventTime=e.E,t.symbol=e.s,t.updateId=e.u,t.bids=e.b,t.asks=e.a):"trade"==t.eventType?(t.event=e.e,t.eventTime=e.E,t.tradeId=e.t,t.price=e.p,t.qty=e.q,t.buyerOrderId=e.b,t.sellerOrderId=e.a,t.time=e.T,t.isBuyerMaker=e.m):"kline"==t.eventType?(t.time=e.t,t.closeTime=e.T,t.symbol=e.s,t.interval=e.i,t.firstId=e.f,t.lastId=e.L,t.open=e.o,t.close=e.c,t.high=e.h,t.low=e.l,t.volume=e.v,t.count=e.n,t.closed=e.x):(console.log("Error! Bad data received:"),console.log(t)),t},t._isDuplicate=function(e){if("depthUpdate"==e.eventType){if(e.updateId>t.lastDepthId)return t.lastDepthId=e.updateId,!1}else if("trade"==e.eventType){if(e.tradeId>t.lastTradeId)return t.lastTradeId=e.tradeId,!1}else console.log("Error! Bad data received:"),console.log(e);return!0},t}}]),app.factory("userStreamer",["$http","$interval",function(e,t){return function(){var e={};return e.isRunning=!1,e.restart=!1,e.startStream=function(t,r){e.isRunning=!0,e.url=t,e.lastTradeIds={},e.backedMsg=[],e.buildingState=!0,e.restart=!0,e.processData=function(t){e._isDuplicate(t)||r(t)},e.ws?e.ws.close():e.ws=e._makeStream()},e.stopStream=function(){e.restart=!1,e.ws&&e.ws.close(),e.lastTradeIds={},e.backedMsg=[],e.buildingState=!0,e.isRunning=!1},e._rolloverStream=function(){console.log("Rolling over stream!"),e.backedMsg=[],e.buildingState=!0,e.ws=e._makeStream()},e._makeStream=function(){var t=new WebSocket(e.url);return t.onopen=function(){console.log("Socket has been opened for: market data!"),e._buildState()},t.onclose=function(t){console.log("Socket has been CLOSED for: market data!"),e.restart?e._rolloverStream():(delete e.ws,console.log("Socket done!"))},t.onmessage=function(t){var r=JSON.parse(t.data);r=e.converter(r),console.log("User data WS recv, eventType: "+r.eventType+", eventTime: "+r.eventTime),e.buildingState?(e.backedMsg.push(r),console.log("Adding msg to backlog: "+r.eventType)):e.processData(r)},t},e._buildState=function(){e.buildingState=!1},e.converter=function(e){var t={};return t.eventType=e.e,"outboundAccountInfo"==t.eventType?(t.eventTime=e.E,t.makerCommission=e.m,t.takerCommission=e.t,t.buyerCommission=e.b,t.sellerCommission=e.s,t.isActive=e.a,t.balances=[],e.B&&e.B.forEach(function(e){t.balances.push({asset:e.a,free:e.f,locked:e.l})}),t.leverage=e.l,t.positions=[],e.p&&e.p.forEach(function(e){t.positions.push({symbol:e.s,usedQty:e.u,usedMargin:e.U,avgQuotePrice:e.q,pendingQtyBuy:e.b,pendingMarginBuy:e.B,pendingQtySell:e.a,pendingMarginSell:e.A,lockedProfitLoss:e.l})})):"executionReport"==t.eventType&&(t.event=e.e,t.eventTime=e.E,t.symbol=e.s,t.clOrdId=e.c,t.side=e.S,t.orderType=e.o,t.timeInForce=e.f,t.qty=e.q,t.price=e.p,t.stopPrice=e.P,t.maxFloor=e.F,t.originalClOrdId=e.C,t.executionType=e.x,t.orderStatus=e.X,t.orderRejectReason=e.r,t.orderId=e.i,t.lastQty=e.l,t.cummulativeQty=e.z,t.lastPrice=e.L,t.commission=e.n,t.commissionAsset=e.N,t.time=e.T,t.executionId=e.I,t.tradeId=e.t,t.workingIndicator=e.w,t.isMaker=e.m),t},e._isDuplicate=function(e){return!1},e}}]);